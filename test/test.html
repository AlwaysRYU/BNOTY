<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8"/>
    <title>Canvas tutorial</title>
    <script type="text/javascript">
        var canvas = null
        var context  = null
        var saveImage = null // 지금 까지 그린 정보를 저장하는 공간
        var figure = null // 활성화된 도형 정보 저장 공간
        function draw(){
            canvas = this.document.createElement("canvas"); // 캔버스 태그를 생성하고 바디에 추가해줌
            canvas.setAttribute("id", "canvas")
            document.body.appendChild( canvas );
            context  = canvas.getContext('2d');

            context.canvas.width  = window.innerWidth;
            context.canvas.height = window.innerHeight;

            context.lineWidth = 10; // 선 두께
            context.strokeStyle = "rgba(255, 0, 0,0.5)"; // 선 색상 + 투명도
            context.fillStyle = "rgba(255, 0, 0,0.5)"; // 채우기 색상

            var sX,sY,eX,eY,mX,mY; // 시작 좌표, 끝 좌표, 끝 좌표(커브)
            var draw = false; // true 일때만 그림 그리기 가능

            canvas.addEventListener ( "mousedown" , function (me) { // 마우스 클릭 이벤트
            mDown (me)}, false );
            
            canvas.addEventListener ( "mousemove" , function (me) { // 마우스 이동 이벤트
            mMove (me)}, false );
            
            canvas.addEventListener ( "mouseup" , function (me) { // 마우스 클릭 땐 이벤트
            mUp (me)}, false );

            canvas.addEventListener ( "mouseout" , function (me) { // 마우스 경계 밖으로 나갈때 이벤트
            mOut (me)}, false );
            
            // 마우스 클릭 
            function mDown(me){
                sX=me.offsetX; // 시작좌표 갱신
                sY=me.offsetY;
                if(draw){ // 이건 곡선 작성할때 사용
                    draw = false;
                    return
                }
                draw = true; // 그리기 시작

            }

            // 마우스 이동
            function mMove(me){
                if(draw){
                    eX=me.offsetX;
                    eY=me.offsetY;
                    context.clearRect(0,0,canvas.width,canvas.height); // 계속 컨버스를 지워준다 why? 도중에 마우스 움직일떄마다 그려지기 때문
                    if(saveImage) // 저장된 정보가 있으면 불러옴 이전에 그렸던 작업을 다시 불러ㅗㅁ
                        context.putImageData(saveImage, 0, 0);
                    if(figure == 'rectangle') // 네모 그리는 부분 시작 좌표에서 해당 너비 높이만큼 그린다
                        context.strokeRect(sX,sY,eX-sX,eY-sY);
                    else if(figure == 'triangle'){ // 세모
                        context.beginPath()
                        context.moveTo((sX+eX)/2, sY) // 시작점(x,y)
                        context.lineTo(sX, eY)
                        context.lineTo(eX, eY)
                        context.lineTo((sX+eX)/2, sY)
                        context.stroke()
                    }else if (figure == 'circle'){ // 동그라미
                        var s = ((eX-sX) / 2) * 0.5522848,
                        o = ((eY-sY) / 2) * 0.5522848,
                        a = sX + eX-sX,
                        r = sY + eY-sY,
                        h = sX + (eX-sX) / 2,
                        c = sY + (eY-sY) / 2;
                        context.beginPath() // 새로운 경로 시작함을 알림 약간 기존 저장된 시작점 그런거 초기화느낌?
                        context.moveTo(sX, c) // 시작점(x,y)
                        context.bezierCurveTo(sX, c - o, h - s, sY, h, sY) //곡선 그리는 부분 첫번째 제어점 (x,y), 두번째 제어점(x,y), 끝점x,y
                        context.bezierCurveTo(h + s, sY, a, c - o, a, c)
                        context.bezierCurveTo(a, c + o, h + s, r, h, r)
                        context.bezierCurveTo(h - s, r, sX, c + o, sX, c)
                        context.stroke() // 이걸 해줌으로써 위에서 작성한 것들 화면에 뿌려줌?
                    }else if(figure == 'line'){ // 직선
                        context.beginPath(),
                        context.moveTo(sX,sY)
                        context.lineTo(eX, eY)
                        context.stroke()
                    }else if(figure == 'curve'){ // 그 여기 들어온 수를 판단해서 점 찍고 하는식으로 해야할거 같은데?
                        context.beginPath()
                        if(mX == null && mY == null){ // 끝 좌표가 없으면 끝좌표를 저장하고 직선 그림
                            context.moveTo(sX,sY)
                            context.lineTo(eX,eY)
                        }else{ // 끝 좌표가 존재하면 마우스 이동좌표에 따른 곡선 그림
                            context.moveTo(sX,sY)
                            context.quadraticCurveTo(me.offsetX, me.offsetY,mX,mY)
                        }
                        context.stroke()
                    }else if(figure == 'arrow'){
                        var headlen = context.lineWidth * 10; // length of head in pixels
  var dx = eX - sX;
  var dy = eY - sY;
  var angle = Math.atan2(dy, dx);
  context.beginPath()
  context.moveTo(sX, sY);
  context.lineTo(eX, eY);
  context.moveTo(eX, eY);
  context.lineTo(eX - headlen * Math.cos(angle - Math.PI / 6), eY - headlen * Math.sin(angle - Math.PI / 6));
  context.moveTo(eX, eY);
  context.lineTo(eX - headlen * Math.cos(angle + Math.PI / 6), eY - headlen * Math.sin(angle + Math.PI / 6));
  context.lineCap = 'round' // 끝을 둥글게
  context.stroke();
  context.lineCap = 'butt' // 끝을 원래로
                        // context.beginPath(),
                        // context.moveTo(sX,sY)
                        // context.lineTo(eX, eY)
                        // context.lineTo(eX, eY+20)
                        // context.moveTo(eX, eY)
                        // context.lineTo(eX, eY-20)
                        
                        // context.stroke() // 직선 그리기


                        // var aWidth = 5+context.lineWidth;
                        // var aLength = 12+context.lineWidth;
                        // var dx = eX - sX;
                        // var dy = eY - sY;
                        // var angle = Math.atan2(dy, dx);
                        // var length = Math.sqrt(dx * dx + dy * dy);
                        // context.clearRect(eX,eY,length - aLength, aWidth);
                        // // //두점 선긋기
                        // context.translate(sX, sY);
                        // context.rotate(angle);
                        // context.beginPath();

                        // //화살표 모양 만들기
                        // context.moveTo(length - aLength, -aWidth);
                        // context.lineTo(length, 0);
                        // context.lineTo(length - aLength, aWidth);

                        // context.fill();
                        // context.setTransform(1, 0, 0, 1, 0, 0);
                    }
                } 
            }    

            // 마우스 놓기
            function mUp(me){
                if(figure == 'curve'){ // 커브면 끝좌표 초기화 or 갱신
                    if(mX == null && mY == null){
                        mX=me.offsetX;
                        mY=me.offsetY;
                        return; // 여기서는 끝좌표만 갱신하고 리턴해줘야 다음작업 가능
                    }else{
                        mX=null
                        mY=null
                    }
                }
                saveImage = context.getImageData(0,0,canvas.width,canvas.height); // 지금까지 그린 정보를 저장
                draw = false; // 그리기 종료
            }

            // 캔버스 범위 벗어남
            function mOut(me) {
                saveImage = context.getImageData(0,0,canvas.width,canvas.height); // 지금까지 그린 정보를 저장
                draw = false ; //그리기 종료
                if(figure == 'curve'){
                    mX=null // 커브에대해서 마지막점 초기화
                    mY=null
                }
            }
        }

        function del(){
            canvas = this.document.getElementById("canvas");
            context  = canvas.getContext('2d');
            saveImage = null
            context.clearRect(0,0,canvas.width,canvas.height); //clear canvas
        }

        function rectangle(){
            figure = 'rectangle'
        }

        function circle(){
            figure = 'circle'
        }

        function line(){
            figure = 'line'
        }

        function curve(){
            figure = 'curve'
        }

        function triangle(){
            figure = 'triangle'
        }

        function arrow(){
            figure = 'arrow'
        }


        function canvas_arrow(context, sX, sY, eX, eY) {
 
}

    </script>
    <style type="text/css">
        canvas {
            background:black; 
            cursor:crosshair;
            width:  100%;
            height: 100%;
        } 
        /* */
    </style>
  </head>
  <body onload="draw();">
    <button onclick="del();">전체지우기</button>
    <button onclick="rectangle();">네모</button>
    <button onclick="triangle();">세모</button>
    <button onclick="circle();">동그라미</button>
    <button onclick="line();">직선</button>
    <button onclick="curve()">곡선</button>
    <button onclick="arrow()">화살표</button>
  </body>
</html>